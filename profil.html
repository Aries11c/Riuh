<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>RIUH - Profil</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; margin: 0; padding: 0; }
    header { background: white; padding: 10px; display: flex; align-items: center; border-bottom: 1px solid #ccc; }
    header h1 { color: blue; margin: 0 15px 0 0; cursor: pointer; }
    header a { text-decoration: none; color: black; margin-left: auto; font-weight: bold; }
    .profile { background: white; padding: 15px; margin: 10px; border-radius: 8px; }
    .profile h2 { margin: 0; }
    .post-form textarea { width: 100%; height: 60px; }
    .post-form button { margin-top: 5px; }
    .post { background: white; padding: 10px; margin: 10px; border-radius: 8px; }
    .comments { margin-top: 10px; padding-left: 10px; border-left: 3px solid #ddd; }
    .comment { margin-bottom: 5px; }
    .comment strong { margin-right: 5px; }
  </style>
</head>
<body>
  <header>
    <h1 onclick="goHome()">RIUH</h1>
    <a href="home.html">Beranda</a>
  </header>

  <div class="profile">
    <h2 id="username"></h2>
    <p id="email"></p>
    <p id="followersCount"></p>
    <div id="actionButtons"></div>
  </div>

  <div id="postSection"></div>
  <div id="posts"></div>

<script>
let currentUser = JSON.parse(localStorage.getItem("currentUser"));
if (!currentUser) location.href = "login.html";

const urlParams = new URLSearchParams(window.location.search);
const profileEmail = urlParams.get("email") || currentUser.email;

function goHome(){ location.href = "home.html"; }

function renderProfile() {
  let users = JSON.parse(localStorage.getItem("users")) || [];
  let user = users.find(u => u.email === profileEmail);
  if (!user) return;

  document.getElementById("username").textContent = user.username;
  document.getElementById("email").textContent = user.email;

  let follows = JSON.parse(localStorage.getItem("follows")) || {};
  let followersCount = Object.values(follows).filter(list => list.includes(profileEmail)).length;
  document.getElementById("followersCount").textContent = `Followers: ${followersCount}`;

  let actionDiv = document.getElementById("actionButtons");
  actionDiv.innerHTML = "";

  if (profileEmail === currentUser.email) {
    actionDiv.innerHTML = `
      <button onclick="editName()">Edit Profil</button>
      <button onclick="logout()">Logout</button>
    `;
    document.getElementById("postSection").innerHTML = `
      <div class="post-form">
        <textarea id="postText" maxlength="1000" placeholder="Tulis postingan..."></textarea>
        <button onclick="addPost()">Posting</button>
      </div>
    `;
  } else {
    let isFollowed = (follows[currentUser.email] || []).includes(profileEmail);
    actionDiv.innerHTML = `<button onclick="toggleFollow()">${isFollowed ? "Followed" : "Follow"}</button>`;
  }
}

function editName(){
  let users = JSON.parse(localStorage.getItem("users")) || [];
  let newName = prompt("Masukkan nama baru:", currentUser.username);
  if (!newName) return;
  currentUser.username = newName;
  let idx = users.findIndex(u => u.email === currentUser.email);
  if (idx !== -1) users[idx].username = newName;
  localStorage.setItem("users", JSON.stringify(users));
  localStorage.setItem("currentUser", JSON.stringify(currentUser));
  renderProfile();
  loadPosts();
}

function logout(){
  localStorage.removeItem("currentUser");
  location.href = "login.html";
}

function toggleFollow(){
  let follows = JSON.parse(localStorage.getItem("follows")) || {};
  if (!follows[currentUser.email]) follows[currentUser.email] = [];
  if (follows[currentUser.email].includes(profileEmail)) {
    follows[currentUser.email] = follows[currentUser.email].filter(e => e !== profileEmail);
  } else {
    follows[currentUser.email].push(profileEmail);
  }
  localStorage.setItem("follows", JSON.stringify(follows));
  renderProfile();
  loadPosts();
}

function addPost(){
  let text = document.getElementById("postText").value.trim();
  if (!text) return;
  let posts = JSON.parse(localStorage.getItem("posts")) || [];
  posts.unshift({
    id: Date.now().toString(),
    username: currentUser.username,
    email: currentUser.email,
    text: text,
    likes: 0,
    likers: []
  });
  localStorage.setItem("posts", JSON.stringify(posts));
  document.getElementById("postText").value = "";
  loadPosts();
}

function loadPosts(){
  let posts = JSON.parse(localStorage.getItem("posts")) || [];
  let comments = JSON.parse(localStorage.getItem("comments")) || {};
  let container = document.getElementById("posts");
  container.innerHTML = "";

  posts.filter(p => p.email === profileEmail).forEach(post => {
    let div = document.createElement("div");
    div.className = "post";
    div.innerHTML = `
      <strong>${post.username}</strong>
      <p>${post.text}</p>
      ${profileEmail === currentUser.email ? `<button onclick="deletePost('${post.id}')">Hapus Postingan</button>` : ""}
      <div class="comments">
        ${(comments[post.id] || []).map((c,i) => `
          <div class="comment">
            <strong>${c.user}</strong> ${c.text}
            ${c.email === currentUser.email ? `<button onclick="deleteComment('${post.id}', ${i})">Hapus</button>` : ""}
          </div>
        `).join("")}
        <input type="text" id="comment-${post.id}" maxlength="500" placeholder="Tulis komentar...">
        <button onclick="addComment('${post.id}')">Kirim</button>
      </div>
    `;
    container.appendChild(div);
  });
}

function deletePost(id){
  let posts = JSON.parse(localStorage.getItem("posts")) || [];
  posts = posts.filter(p => p.id !== id);
  localStorage.setItem("posts", JSON.stringify(posts));
  loadPosts();
}

function addComment(postId){
  let input = document.getElementById(`comment-${postId}`);
  let text = input.value.trim();
  if (!text) return;
  let comments = JSON.parse(localStorage.getItem("comments")) || {};
  if (!comments[postId]) comments[postId] = [];
  comments[postId].push({ user: currentUser.username, email: currentUser.email, text });
  localStorage.setItem("comments", JSON.stringify(comments));
  input.value = "";
  loadPosts();
}

function deleteComment(postId, index){
  let comments = JSON.parse(localStorage.getItem("comments")) || {};
  if (comments[postId]) {
    comments[postId].splice(index, 1);
    localStorage.setItem("comments", JSON.stringify(comments));
    loadPosts();
  }
}

renderProfile();
loadPosts();
</script>
</body>
</html>