<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Profil</title>
<style>
  body{ font-family:'Segoe UI',sans-serif; background:#f3f4f6; margin:0; padding:20px }
  .box{
    max-width:560px; margin:auto; background:#fff; border-radius:12px;
    box-shadow:0 2px 10px rgba(0,0,0,.08); padding:18px
  }
  h2{ margin:0 0 6px }
  .muted{ color:#666; margin:0 0 4px }
  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .btn{ border:none; padding:8px 12px; border-radius:8px; cursor:pointer }
  .edit{ background:#ffb703; color:#fff }
  .logout{ background:#e63946; color:#fff }
  .follow{ background:#2563eb; color:#fff }
  .follow[disabled]{ opacity:.6; cursor:default }
  .postbox{ margin-top:14px; border:1px solid #e5e7eb; border-radius:10px; padding:10px }
  textarea{ width:100%; resize:none; padding:10px; border:1px solid #e5e7eb; border-radius:8px }
  .post{ background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; padding:10px; margin-top:12px }
  .small{ font-size:12px; color:#666 }
  .danger{ background:#ef4444; color:#fff; border:none; padding:4px 8px; border-radius:6px; cursor:pointer }
  .head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px }
  .link{ color:#2575fc; text-decoration:none }
</style>
</head>
<body>
<div class="box">
  <div class="head">
    <a class="link" href="home.html">← Beranda</a>
    <strong>Profil</strong>
    <span></span>
  </div>

  <h2 id="uName"></h2>
  <p class="muted" id="uEmail"></p>
  <p class="muted"><b>Followers:</b> <span id="uFollowers">0</span></p>

  <div class="row" id="controls"></div>

  <div id="myPostForm" class="postbox" style="display:none">
    <h3>Buat Postingan</h3>
    <textarea id="postText" maxlength="1000" placeholder="Tulis sesuatu..."></textarea><br><br>
    <button class="btn follow" id="btnPost">Posting</button>
  </div>

  <h3 style="margin-top:16px">Postingan</h3>
  <div id="listPosts"></div>
</div>

<script>
const me = JSON.parse(localStorage.getItem("loggedInUser"));
if(!me){ location.href="login.html"; }

function getUsers(){ return JSON.parse(localStorage.getItem("users")) || []; }
function setUsers(u){ localStorage.setItem("users", JSON.stringify(u)); }
function getPosts(){ return JSON.parse(localStorage.getItem("posts")) || []; }
function setPosts(p){ localStorage.setItem("posts", JSON.stringify(p)); }
function getFollows(){ return JSON.parse(localStorage.getItem("follows")) || {}; }
function setFollows(f){ localStorage.setItem("follows", JSON.stringify(f)); }

function countFollowers(email){
  const f = getFollows();
  let n = 0;
  for(const follower in f){
    if((f[follower] || []).includes(email)) n++;
  }
  return n;
}
function isFollowing(target){
  const f = getFollows();
  return (f[me.email] || []).includes(target);
}
function followOnce(target){
  if(target === me.email) return;
  const f = getFollows();
  const arr = f[me.email] || [];
  if(!arr.includes(target)){
    arr.push(target);
    f[me.email] = arr;
    setFollows(f);
    drawHeader(); // refresh followers count + tombol
  }
}

const params = new URLSearchParams(location.search);
const profileEmail = params.get("email") || me.email;

function userByEmail(email){
  return getUsers().find(u => u.email === email);
}
function currentDisplayName(email){
  const u = userByEmail(email);
  return u ? u.username : email;
}

// Inisialisasi profil target
let profileUser = userByEmail(profileEmail);
if(!profileUser){
  alert("Pengguna tidak ditemukan."); location.href="home.html";
}

function drawHeader(){
  // Perbarui nama/email/followers
  document.getElementById("uName").textContent = currentDisplayName(profileUser.email);
  document.getElementById("uEmail").textContent = profileUser.email;
  document.getElementById("uFollowers").textContent = countFollowers(profileUser.email);

  const controls = document.getElementById("controls");
  controls.innerHTML = "";

  if(profileUser.email === me.email){
    // Profil sendiri: Edit + Logout, dan tampilkan form posting
    const bEdit = document.createElement("button");
    bEdit.className = "btn edit"; bEdit.textContent = "Edit Profil";
    bEdit.onclick = editName;

    const bLogout = document.createElement("button");
    bLogout.className = "btn logout"; bLogout.textContent = "Logout";
    bLogout.onclick = ()=>{ localStorage.removeItem("loggedInUser"); location.href="login.html"; };

    controls.appendChild(bEdit);
    controls.appendChild(bLogout);
    document.getElementById("myPostForm").style.display = "";
  }else{
    // Profil orang: hanya tombol Follow/Followed
    const bFollow = document.createElement("button");
    bFollow.className = "btn follow";
    const already = isFollowing(profileUser.email);
    bFollow.textContent = already ? "Followed" : "Follow";
    if(already) bFollow.disabled = true;
    bFollow.onclick = ()=> followOnce(profileUser.email);
    controls.appendChild(bFollow);
    document.getElementById("myPostForm").style.display = "none";
  }
}

function editName(){
  const newName = prompt("Masukkan nama baru:", currentDisplayName(me.email));
  if(!newName || !newName.trim()) return;
  // Update user
  const users = getUsers().map(u => u.email===me.email ? {...u, username:newName.trim()} : u);
  setUsers(users);
  // Update loggedInUser
  const updatedMe = {...me, username:newName.trim()};
  localStorage.setItem("loggedInUser", JSON.stringify(updatedMe));
  // Opsional: update nama di semua post milik user (agar konsisten di data)
  const posts = getPosts().map(p => p.email===me.email ? {...p, username:newName.trim()} : p);
  setPosts(posts);
  // refresh tampilan
  drawHeader();
  renderPosts();
  alert("Nama berhasil diperbarui!");
}

// Buat postingan (hanya profil sendiri)
document.getElementById("btnPost").onclick = ()=>{
  const t = document.getElementById("postText");
  const text = (t.value||"").trim();
  if(!text){ alert("Isi postingan tidak boleh kosong."); return; }
  const posts = getPosts();
  posts.push({
    id: Date.now(),
    email: me.email,
    username: currentDisplayName(me.email), // snapshot; juga kita update saat ganti nama
    text,
    likes: 0,
    likedBy: []
  });
  setPosts(posts);
  t.value = "";
  renderPosts();
};

function renderPosts(){
  const wrap = document.getElementById("listPosts");
  wrap.innerHTML = "";
  const posts = getPosts()
    .filter(p => p.email === profileUser.email)
    .sort((a,b)=>b.id - a.id);

  if(posts.length === 0){
    wrap.innerHTML = "<p class='small'>Belum ada postingan.</p>";
    return;
  }

  posts.forEach(p=>{
    const div = document.createElement("div");
    div.className = "post";
    div.innerHTML = `
      <div style="font-weight:600; color:#2575fc">${currentDisplayName(p.email)}</div>
      <div style="white-space:pre-wrap; margin:6px 0">${p.text}</div>
      <div class="row">
        <button class="btn" data-like="${p.id}">❤️ ${p.likes||0}</button>
        ${p.email===me.email ? `<button class="danger" data-del="${p.id}">Hapus</button>` : ""}
      </div>
    `;
    wrap.appendChild(div);
  });

  // Delegasi klik like/hapus
  wrap.onclick = (e)=>{
    const t = e.target;
    if(t.dataset.like){
      likeToggle(parseInt(t.dataset.like,10));
    }else if(t.dataset.del){
      deletePost(parseInt(t.dataset.del,10));
    }
  };
}

function likeToggle(id){
  const posts = getPosts();
  const i = posts.findIndex(p => p.id===id);
  if(i===-1) return;
  posts[i].likedBy = posts[i].likedBy || [];
  posts[i].likes = posts[i].likes || 0;
  const pos = posts[i].likedBy.indexOf(me.email);
  if(pos===-1){
    posts[i].likedBy.push(me.email);
    posts[i].likes++;
  }else{
    // jika tak ingin un-like, comment 3 baris ini
    posts[i].likedBy.splice(pos,1);
    posts[i].likes = Math.max(0, posts[i].likes-1);
  }
  setPosts(posts);
  renderPosts();
}

function deletePost(id){
  const posts = getPosts().filter(p => !(p.id===id && p.email===me.email));
  setPosts(posts);
  renderPosts();
}

// First paint
drawHeader();
renderPosts();
</script>
</body>
</html>