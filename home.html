<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>RIUH - Beranda</title>
<style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; }
    header { background: #007bff; color: white; padding: 10px; display: flex; align-items: center; }
    header h1 { margin: 0; font-size: 24px; }
    header a { color: white; margin-left: 15px; text-decoration: none; font-weight: bold; }
    .container { padding: 15px; }
    .post { background: white; padding: 10px; margin-bottom: 15px; border-radius: 5px; }
    .post h3 { margin: 0 0 5px; }
    .post small { color: gray; }
    .actions button { margin-right: 10px; }
    .comments { margin-top: 10px; padding-left: 10px; border-left: 2px solid #ddd; }
    .comment { background: #f0f0f0; padding: 5px; margin-bottom: 5px; border-radius: 3px; }
</style>
</head>
<body>

<header>
    <h1>RIUH</h1>
    <a href="profil.html">Profil</a>
</header>

<div class="container" id="postsContainer"></div>

<script>
    // Cek login lebih aman
    let currentUserRaw = localStorage.getItem("currentUser");
    if (!currentUserRaw) {
        window.location.href = "login.html";
    }
    let currentUser;
    try {
        currentUser = JSON.parse(currentUserRaw);
        if (!currentUser || !currentUser.email) throw "Invalid";
    } catch {
        window.location.href = "login.html";
    }

    // Ambil data
    let posts = JSON.parse(localStorage.getItem("posts") || "[]");
    let comments = JSON.parse(localStorage.getItem("comments") || "{}");
    let users = JSON.parse(localStorage.getItem("users") || "[]");

    function saveData() {
        localStorage.setItem("posts", JSON.stringify(posts));
        localStorage.setItem("comments", JSON.stringify(comments));
        localStorage.setItem("users", JSON.stringify(users));
    }

    function renderPosts() {
        const container = document.getElementById("postsContainer");
        container.innerHTML = "";
        posts.slice().reverse().forEach(post => {
            let postUser = users.find(u => u.email === post.email);
            let likes = post.likes || 0;
            let likedBy = post.likedBy || [];
            let isLiked = likedBy.includes(currentUser.email);

            // follow status
            let postOwner = users.find(u => u.email === post.email);
            if (!postOwner.followers) postOwner.followers = [];
            let isFollowing = postOwner.followers.includes(currentUser.email);

            // Post HTML
            const postDiv = document.createElement("div");
            postDiv.className = "post";
            postDiv.innerHTML = `
                <h3 style="cursor:pointer;color:#007bff" onclick="viewProfile('${post.email}')">${postUser.username}</h3>
                <p>${post.text}</p>
                <div class="actions">
                    <button onclick="toggleLike('${post.id}')">${isLiked ? "Batal Suka" : "Suka"} (${likes})</button>
                    ${post.email !== currentUser.email ? `<button onclick="toggleFollow('${post.email}')">${isFollowing ? "Followed" : "Follow"}</button>` : ""}
                </div>
                <div class="comments" id="comments-${post.id}"></div>
                <input type="text" id="input-comment-${post.id}" placeholder="Tulis komentar..." maxlength="500">
                <button onclick="addComment('${post.id}')">Kirim</button>
            `;

            container.appendChild(postDiv);
            renderComments(post.id);
        });
    }

    function toggleLike(postId) {
        let post = posts.find(p => p.id === postId);
        if (!post.likedBy) post.likedBy = [];
        if (post.likedBy.includes(currentUser.email)) {
            post.likedBy = post.likedBy.filter(e => e !== currentUser.email);
            post.likes--;
        } else {
            post.likedBy.push(currentUser.email);
            post.likes++;
        }
        saveData();
        renderPosts();
    }

    function toggleFollow(email) {
        let targetUser = users.find(u => u.email === email);
        if (!targetUser.followers) targetUser.followers = [];
        if (targetUser.followers.includes(currentUser.email)) {
            targetUser.followers = targetUser.followers.filter(e => e !== currentUser.email);
        } else {
            targetUser.followers.push(currentUser.email);
        }
        saveData();
        renderPosts();
    }

    function addComment(postId) {
        let input = document.getElementById("input-comment-" + postId);
        let text = input.value.trim();
        if (!text) return;
        if (!comments[postId]) comments[postId] = [];
        comments[postId].push({ user: currentUser.username, email: currentUser.email, text: text });
        localStorage.setItem("comments", JSON.stringify(comments));
        input.value = "";
        renderComments(postId);
    }

    function renderComments(postId) {
        let container = document.getElementById("comments-" + postId);
        container.innerHTML = "";
        (comments[postId] || []).forEach((c, index) => {
            let commentDiv = document.createElement("div");
            commentDiv.className = "comment";
            commentDiv.innerHTML = `<strong>${c.user}</strong>: ${c.text} ${c.email === currentUser.email ? `<button onclick="deleteComment('${postId}',${index})">Hapus</button>` : ""}`;
            container.appendChild(commentDiv);
        });
    }

    function deleteComment(postId, index) {
        comments[postId].splice(index, 1);
        localStorage.setItem("comments", JSON.stringify(comments));
        renderComments(postId);
    }

    function viewProfile(email) {
        window.location.href = "profil.html?email=" + encodeURIComponent(email);
    }

    renderPosts();
</script>

</body>
</html>