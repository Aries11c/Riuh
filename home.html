<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>RIUH - Home</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; margin: 0; padding: 0; }
    header { background: white; padding: 10px; display: flex; align-items: center; border-bottom: 1px solid #ccc; }
    header h1 { color: blue; margin: 0 15px 0 0; cursor: pointer; }
    header a { text-decoration: none; color: black; margin-left: auto; font-weight: bold; }
    .post { background: white; padding: 10px; margin: 10px; border-radius: 8px; }
    .post .username { font-weight: bold; cursor: pointer; }
    .actions button { margin-right: 10px; }
    .comments { margin-top: 10px; padding-left: 10px; border-left: 3px solid #ddd; }
    .comment { margin-bottom: 5px; }
    .comment strong { margin-right: 5px; }
  </style>
</head>
<body>
  <header>
    <h1 onclick="goHome()">RIUH</h1>
    <a href="#" id="profileLink">Profil</a>
  </header>
  <div id="posts"></div>

<script>
let currentUser = JSON.parse(localStorage.getItem("currentUser"));
if (!currentUser) location.href = "login.html";

document.getElementById("profileLink").href = `profil.html?email=${currentUser.email}`;

function goHome(){ location.href = "home.html"; }

function loadPosts() {
  let posts = JSON.parse(localStorage.getItem("posts")) || [];
  let comments = JSON.parse(localStorage.getItem("comments")) || {};
  let container = document.getElementById("posts");
  container.innerHTML = "";

  posts.forEach(post => {
    let div = document.createElement("div");
    div.className = "post";
    let userLink = `<span class="username" onclick="viewProfile('${post.email}')">${post.username}</span>`;
    div.innerHTML = `
      ${userLink}
      <p>${post.text}</p>
      <div class="actions">
        <button onclick="likePost('${post.id}')">Suka (${post.likes || 0})</button>
        <button onclick="toggleFollow('${post.email}')">${isFollowing(post.email) ? 'Followed' : 'Follow'}</button>
      </div>
      <div class="comments">
        ${(comments[post.id] || []).map((c,i) => `
          <div class="comment">
            <strong>${c.user}</strong> ${c.text}
            ${c.email === currentUser.email ? `<button onclick="deleteComment('${post.id}', ${i})">Hapus</button>` : ""}
          </div>
        `).join("")}
        <input type="text" id="comment-${post.id}" maxlength="500" placeholder="Tulis komentar...">
        <button onclick="addComment('${post.id}')">Kirim</button>
      </div>
    `;
    container.appendChild(div);
  });
}

function viewProfile(email){ location.href = `profil.html?email=${email}`; }

function likePost(id){
  let posts = JSON.parse(localStorage.getItem("posts")) || [];
  let post = posts.find(p => p.id === id);
  if (!post) return;
  if (!post.likers) post.likers = [];
  if (!post.likers.includes(currentUser.email)) {
    post.likers.push(currentUser.email);
    post.likes = (post.likes || 0) + 1;
    localStorage.setItem("posts", JSON.stringify(posts));
    loadPosts();
  }
}

function isFollowing(email){
  let follows = JSON.parse(localStorage.getItem("follows")) || {};
  return follows[currentUser.email]?.includes(email);
}

function toggleFollow(email){
  if (email === currentUser.email) return;
  let follows = JSON.parse(localStorage.getItem("follows")) || {};
  if (!follows[currentUser.email]) follows[currentUser.email] = [];
  if (isFollowing(email)) {
    follows[currentUser.email] = follows[currentUser.email].filter(e => e !== email);
  } else {
    follows[currentUser.email].push(email);
  }
  localStorage.setItem("follows", JSON.stringify(follows));
  loadPosts();
}

function addComment(postId){
  let input = document.getElementById(`comment-${postId}`);
  let text = input.value.trim();
  if (!text) return;
  let comments = JSON.parse(localStorage.getItem("comments")) || {};
  if (!comments[postId]) comments[postId] = [];
  comments[postId].push({ user: currentUser.username, email: currentUser.email, text });
  localStorage.setItem("comments", JSON.stringify(comments));
  input.value = "";
  loadPosts();
}

function deleteComment(postId, index){
  let comments = JSON.parse(localStorage.getItem("comments")) || {};
  if (comments[postId]) {
    comments[postId].splice(index, 1);
    localStorage.setItem("comments", JSON.stringify(comments));
    loadPosts();
  }
}

loadPosts();
</script>
</body>
</html>