<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>RIUH - Home</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; margin: 0; padding: 0; }
    header { background: white; padding: 10px; display: flex; align-items: center; border-bottom: 1px solid #ccc; position: sticky; top: 0; z-index: 10; }
    header h1 { color: #2575fc; margin: 0 15px 0 0; cursor: pointer; }
    header a { text-decoration: none; color: black; margin-left: auto; font-weight: bold; }
    #posts { max-width: 700px; margin: 12px auto; padding: 0 10px; }
    .post { background: white; padding: 12px; margin: 10px 0; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,.06); }
    .username { font-weight: bold; color: #2575fc; cursor: pointer; }
    .text { white-space: pre-wrap; margin: 6px 0 10px; }
    .actions button { margin-right: 8px; padding: 6px 10px; border: none; border-radius: 8px; cursor: pointer; background: #e5e7eb; }
    .actions button:disabled { opacity: .6; cursor: default; }
    .comments { margin-top: 10px; padding-left: 10px; border-left: 3px solid #ddd; }
    .comment { margin-bottom: 6px; }
    .comment strong { margin-right: 5px; color: #111; }
    .comment button { border: none; background: #ef4444; color: white; padding: 2px 6px; border-radius: 6px; cursor: pointer; margin-left: 6px; }
    .comment-input { display: flex; gap: 6px; margin-top: 6px; }
    .comment-input input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 8px; }
    .comment-input button { padding: 8px 12px; border: none; border-radius: 8px; background: #2575fc; color: white; cursor: pointer; }
  </style>
</head>
<body>
  <header>
    <h1 onclick="goHome()">RIUH</h1>
    <a href="#" id="profileLink">Profil</a>
  </header>
  <div id="posts"></div>

<script>
// ===== Utils Session (kompatibilitas currentUser -> loggedInUser) =====
function getSessionUser() {
  let u = JSON.parse(localStorage.getItem("loggedInUser"));
  if (!u) {
    const legacy = JSON.parse(localStorage.getItem("currentUser"));
    if (legacy) {
      localStorage.setItem("loggedInUser", JSON.stringify(legacy));
      localStorage.removeItem("currentUser");
      u = legacy;
    }
  }
  return u;
}
function clearSessionUser() {
  localStorage.removeItem("loggedInUser");
  localStorage.removeItem("currentUser");
}

// ===== Helpers Storage =====
function getUsers(){ return JSON.parse(localStorage.getItem("users")) || []; }
function getPosts(){ return JSON.parse(localStorage.getItem("posts")) || []; }
function setPosts(p){ localStorage.setItem("posts", JSON.stringify(p)); }
function getFollows(){ return JSON.parse(localStorage.getItem("follows")) || {}; }
function setFollows(f){ localStorage.setItem("follows", JSON.stringify(f)); }
function getComments(){ return JSON.parse(localStorage.getItem("comments")) || {}; }
function setComments(c){ localStorage.setItem("comments", JSON.stringify(c)); }

const me = getSessionUser();
if (!me) location.href = "login.html";
document.getElementById("profileLink").href = `profil.html?email=${encodeURIComponent(me.email)}`;

function goHome(){ location.href = "home.html"; }

function isFollowing(email){
  const f = getFollows();
  return (f[me.email] || []).includes(email);
}
function toggleFollow(email){
  if (email === me.email) return;
  const f = getFollows();
  const my = f[me.email] || [];
  const i = my.indexOf(email);
  if (i === -1) my.push(email);
  else my.splice(i, 1);
  f[me.email] = my;
  setFollows(f);
  loadPosts();
}

function likePost(id){
  const posts = getPosts();
  const idx = posts.findIndex(p => String(p.id) === String(id));
  if (idx === -1) return;
  posts[idx].likers = posts[idx].likers || [];
  posts[idx].likes = posts[idx].likes || 0;
  if (!posts[idx].likers.includes(me.email)) {
    posts[idx].likers.push(me.email);
    posts[idx].likes++;
    setPosts(posts);
    loadPosts();
  }
}

function addComment(postId){
  const input = document.getElementById(`comment-${postId}`);
  const text = (input.value || "").trim();
  if (!text) return;
  const all = getComments();
  const pid = String(postId);
  all[pid] = all[pid] || [];
  all[pid].push({ user: me.username, email: me.email, text });
  setComments(all);
  input.value = "";
  loadPosts();
}
function deleteComment(postId, index){
  const all = getComments();
  const pid = String(postId);
  if (!all[pid]) return;
  const c = all[pid][index];
  if (!c || c.email !== me.email) return; // hanya boleh hapus komentar sendiri
  all[pid].splice(index, 1);
  setComments(all);
  loadPosts();
}

function viewProfile(email){ location.href = `profil.html?email=${encodeURIComponent(email)}`; }

function loadPosts() {
  const posts = getPosts().sort((a,b)=> Number(b.id) - Number(a.id));
  const comments = getComments();
  const container = document.getElementById("posts");
  container.innerHTML = "";

  posts.forEach(post => {
    const pid = String(post.id);
    const div = document.createElement("div");
    div.className = "post";
    const uname = `<span class="username" onclick="viewProfile('${post.email}')">${post.username}</span>`;
    div.innerHTML = `
      ${uname}
      <div class="text">${(post.text || "").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
      <div class="actions">
        <button onclick="likePost('${pid}')">❤️ Suka (${post.likes || 0})</button>
        <button onclick="toggleFollow('${post.email}')" ${post.email===me.email ? "disabled" : ""}>
          ${post.email===me.email ? "Follow (disabled)" : (isFollowing(post.email) ? "Followed" : "Follow")}
        </button>
      </div>
      <div class="comments" id="cwrap-${pid}">
        ${(comments[pid] || []).map((c,i) => `
          <div class="comment">
            <strong>${c.user}</strong> ${c.text.replace(/</g,"&lt;").replace(/>/g,"&gt;")}
            ${c.email === me.email ? `<button onclick="deleteComment('${pid}', ${i})">Hapus</button>` : ""}
          </div>
        `).join("")}
        <div class="comment-input">
          <input type="text" id="comment-${pid}" maxlength="500" placeholder="Tulis komentar...">
          <button onclick="addComment('${pid}')">Kirim</button>
        </div>
      </div>
    `;
    container.appendChild(div);
  });
}

loadPosts();
</script>
</body>
</html>